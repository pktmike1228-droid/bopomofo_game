<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨éŸ³ç¬¦è™Ÿéš¨æ©Ÿè½è®€ç·´ç¿’ - æœ€çµ‚ç©©å®šç‰ˆ (è·¨è£ç½®ç™¼éŸ³ä¿®æ­£)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            margin: 0;
            color: #333;
        }

        #game-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        #stats-container {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        #bopomofo-display {
            font-weight: bold;
            margin: 40px 0;
            color: #e74c3c;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffebee;
            border-radius: 10px;
            line-height: 1; 
            transition: font-size 0.3s, color 0.3s; 
        }

        #button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        #test-button {
            background-color: #9b59b6;
        }
        #test-button:hover {
            background-color: #8e44ad;
        }

        .action-button {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }

        #next-button {
            background-color: #3498db;
        }

        #next-button:hover {
            background-color: #2980b9;
        }
        
        #listen-button {
            background-color: #2ecc71;
        }

        #listen-button:hover {
            background-color: #27ae60;
        }
        
        #reset-button {
            background-color: #f39c12; 
        }
        
        #reset-button:hover {
            background-color: #e67e22;
        }


        .action-button:active {
            transform: scale(0.98);
        }

        #message {
            margin-top: 20px;
            font-size: 1.2em;
            color: #7f8c8d;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <h1>æ³¨éŸ³ç¬¦è™Ÿéš¨æ©Ÿè½è®€ç·´ç¿’ ğŸ’¡</h1>
        
        <div id="stats-container">
            <button id="reset-button" class="action-button" onclick="resetGame()">é‡æ–°é–‹å§‹ ğŸ”„</button>
            <div id="counter-display">å·²ç·´ç¿’é¡Œæ•¸: 0</div>
        </div>

        <div id="bopomofo-display">é»æ“Šä¸‹ä¸€é¡Œé–‹å§‹</div>

        <div id="button-group">
            <button id="next-button" class="action-button" onclick="startNewRound()">ä¸‹ä¸€é¡Œ</button>
            <button id="listen-button" class="action-button" onclick="playCurrentSound()" disabled>ğŸ‘‚ è½è½çœ‹</button>
        </div>
        
        <button id="test-button" class="action-button" onclick="testSpeech()">ğŸ”Š èªéŸ³æ¸¬è©¦</button>
        
        <div id="message">è«‹é»æ“Šã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ç·´ç¿’</div>

    </div>

<script>
    const bopomofo = [
        "ã„…", "ã„†", "ã„‡", "ã„ˆ", "ã„‰", "ã„Š", "ã„‹", "ã„Œ", "ã„", "ã„", "ã„",
        "ã„", "ã„‘", "ã„’", "ã„“", "ã„”", "ã„•", "ã„–", "ã„—", "ã„˜", "ã„™",
        "ã„§", "ã„¨", "ã„©", "ã„š", "ã„›", "ã„œ", "ã„", "ã„", "ã„Ÿ", "ã„ ", "ã„¡",
        "ã„¢", "ã„£", "ã„¤", "ã„¥", "ã„¦"
    ];

    // å„ªåŒ–å¾Œçš„æ‹¼éŸ³è¡¨ï¼šåŠ ä¸Šè²èª¿ç¬¦è™Ÿï¼Œç¢ºä¿å¤§é™¸å£éŸ³ä¹Ÿèƒ½è®€å‡ºç¬¬ä¸€è²ï¼ˆè¼ƒæ¥è¿‘æ³¨éŸ³æ•™å­¸ï¼‰
    const bopomofoMap = {
        "ã„…": "bÅ", "ã„†": "pÅ", "ã„‡": "mÅ", "ã„ˆ": "fÅ", 
        "ã„‰": "dÄ“", "ã„Š": "tÄ“", "ã„‹": "nÄ“", "ã„Œ": "lÄ“", 
        "ã„": "gÄ“", "ã„": "kÄ“", "ã„": "hÄ“",
        "ã„": "jÄ«", "ã„‘": "qÄ«", "ã„’": "xÄ«", 
        "ã„“": "zhÄ«", "ã„”": "chÄ«", "ã„•": "shÄ«", "ã„–": "rÄ«", 
        "ã„—": "zÄ«", "ã„˜": "cÄ«", "ã„™": "sÄ«",
        "ã„§": "yÄ«", "ã„¨": "wÅ«", "ã„©": "yÅ«", 
        "ã„š": "Ä", "ã„›": "Å", "ã„œ": "Ä“", "ã„": "iÄ“", // ã„ æ”¹ç‚º ie ç™¼éŸ³è¼ƒæº–
        "ã„": "Äi", "ã„Ÿ": "Ä“i", "ã„ ": "Äo", "ã„¡": "Åu",
        "ã„¢": "Än", "ã„£": "Ä“n", "ã„¤": "Äng", "ã„¥": "Ä“ng", "ã„¦": "Ã©r"
    };

    let currentSymbol = '';
    let roundCounter = 0; 

    const displayEl = document.getElementById('bopomofo-display');
    const messageEl = document.getElementById('message');
    const listenButton = document.getElementById('listen-button');
    const counterDisplay = document.getElementById('counter-display');
    const testButton = document.getElementById('test-button');
    
    const synth = window.speechSynthesis;
    let targetVoice = null; 
    let usePinyinFallback = false; 

    // ----------------------------------------------------
    // I. èªéŸ³åˆæˆæ ¸å¿ƒå‡½æ•¸ (ä¿®å¾©ç‰ˆ)
    // ----------------------------------------------------

    function loadChineseVoice() {
        const voices = synth.getVoices();
        if (voices.length === 0) return;

        // 1. å„ªå…ˆå°‹æ‰¾æ˜ç¢ºçš„å°ç£ç¹é«”èªéŸ³ (åŒ…å« Mac/iOS çš„ zh-Hant-TW)
        targetVoice = voices.find(v => 
            v.lang === 'zh-TW' || 
            v.lang === 'zh-Hant-TW' || 
            v.name.includes('Taiwan')
        );

        // 2. åˆ¤æ–·æ˜¯å¦ä½¿ç”¨æ‹¼éŸ³æ›¿ä»£
        if (targetVoice) {
            // æ‰¾åˆ°äº†å°ç£èªéŸ³ï¼Œç›´æ¥è®€æ³¨éŸ³
            usePinyinFallback = false;
            console.log(`ä½¿ç”¨å°ç£èªéŸ³: ${targetVoice.name}`);
        } else {
            // æ²’æ‰¾åˆ°å°ç£èªéŸ³ï¼Œé€€è€Œæ±‚å…¶æ¬¡æ‰¾ä»»ä½•ä¸­æ–‡ (zh-CN, zh-HK ç­‰)
            targetVoice = voices.find(v => v.lang.startsWith('zh') || v.name.includes('Chinese'));
            
            // ã€é—œéµä¿®æ­£ã€‘åªè¦ä¸æ˜¯æ­£å®—å°ç£èªéŸ³ï¼Œä¸€å¾‹å¼·åˆ¶è½‰æ‹¼éŸ³
            // å› ç‚ºå¤§é™¸æˆ–é€šç”¨èªéŸ³å¼•æ“é€šå¸¸çœ‹ä¸æ‡‚æ³¨éŸ³ç¬¦è™Ÿ
            usePinyinFallback = true;
            console.warn("æœªæ‰¾åˆ°å°ç£èªéŸ³ï¼Œå•Ÿç”¨å¼·åˆ¶æ‹¼éŸ³ fallback æ¨¡å¼ã€‚");
        }
    }
    
    // ç›£è½èªéŸ³æ¸…å–®è®Šæ›´ (ç‰¹åˆ¥æ˜¯é‡å° Chrome/Android)
    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadChineseVoice;
    }

    function speakText(text, btn, originalText) {
        if (synth.speaking) {
            synth.cancel();
        }

        // ç¢ºä¿æœ‰å˜—è©¦è¼‰å…¥èªéŸ³
        if (!targetVoice) loadChineseVoice();

        let textToSpeak = text;
        
        // é‚è¼¯ä¿®æ­£ï¼šå¦‚æœéœ€è¦ Fallbackï¼Œä¸”è©²ç¬¦è™Ÿåœ¨æ˜ å°„è¡¨ä¸­æœ‰ï¼Œå°±æ›æˆæ‹¼éŸ³
        if (usePinyinFallback && bopomofoMap[text]) {
            textToSpeak = bopomofoMap[text];
        } else {
            // å³ä½¿æ˜¯å°ç£èªéŸ³ï¼Œæœ‰æ™‚å€™è®€å–®å€‹æ³¨éŸ³ä¹Ÿæœƒæ€ªæ€ªçš„ï¼Œ
            // é€™è£¡å¯ä»¥é¸æ“‡æ€§ä¿ç•™åŸå­—ï¼Œæˆ–è€…è¦–æƒ…æ³èª¿æ•´ã€‚
            // ç›®å‰ç¶­æŒåŸå­—ã€‚
        }
        
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        
        if (targetVoice) {
            utterance.voice = targetVoice;
            utterance.lang = targetVoice.lang;
        } else {
            // æ¥µç«¯æƒ…æ³ï¼šç³»çµ±å®Œå…¨æ²’æœ‰ä¸­æ–‡èªéŸ³ï¼Œå˜—è©¦ç›²è¨­ zh-TW
            utterance.lang = 'zh-TW'; 
        }

        // èª¿æ•´åƒæ•¸è®“ç™¼éŸ³æ¸…æ¥šé»
        utterance.rate = 0.8; 
        utterance.pitch = 1.0; 

        btn.textContent = 'ğŸ”Š æ­£åœ¨ç™¼éŸ³...';
        btn.disabled = true;

        utterance.onend = function() {
            btn.textContent = originalText;
            btn.disabled = false;
        };
        
        utterance.onerror = function(e) {
            console.error("Speech Error:", e);
            // å¾ˆå¤šç€è¦½å™¨åœ¨ cancel() æ™‚æœƒè§¸ç™¼ errorï¼Œå¿½ç•¥å®ƒ
            if (e.error !== 'canceled') {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        synth.speak(utterance);
    }

    // ----------------------------------------------------
    // II. éŠæˆ²æµç¨‹èˆ‡ä»‹é¢æ§åˆ¶
    // ----------------------------------------------------

    function playCurrentSound() {
        if (!currentSymbol || listenButton.disabled) return;
        speakText(currentSymbol, listenButton, 'ğŸ‘‚ è½è½çœ‹');
    }

    function testSpeech() {
        if (testButton.disabled) return;
        // æ¸¬è©¦å¥ï¼šå¦‚æœæ˜¯å¤§é™¸èªéŸ³ï¼Œé€™å¥è©±æœƒè®€å¾—å¾ˆæ²èˆŒ
        speakText('æ¸¬è©¦', testButton, 'ğŸ”Š èªéŸ³æ¸¬è©¦');
    }

    function startNewRound() {
        roundCounter++; 
        counterDisplay.textContent = `å·²ç·´ç¿’é¡Œæ•¸: ${roundCounter}`;

        currentSymbol = bopomofo[Math.floor(Math.random() * bopomofo.length)];
        displayEl.textContent = currentSymbol;
        
        displayEl.style.fontSize = '15em'; 
        displayEl.style.color = '#e74c3c'; 

        listenButton.disabled = false;
        listenButton.textContent = 'ğŸ‘‚ è½è½çœ‹';
        messageEl.textContent = `é¡Œç›®ï¼š${currentSymbol}`;
        
        synth.cancel(); 
    }
    
    function resetGame() {
        roundCounter = 0;
        counterDisplay.textContent = `å·²ç·´ç¿’é¡Œæ•¸: 0`;
        currentSymbol = '';
        
        displayEl.textContent = 'æº–å‚™å¥½äº†å—ï¼Ÿ';
        displayEl.style.fontSize = '3em'; 
        displayEl.style.color = '#7f8c8d'; 
        
        listenButton.disabled = true;
        listenButton.textContent = 'ğŸ‘‚ è½è½çœ‹';
        messageEl.textContent = 'é»æ“Šã€Œä¸‹ä¸€é¡Œã€é–‹å§‹';

        synth.cancel(); 
        
        // iOS Safari éœ€è¦åœ¨ä½¿ç”¨è€…äº’å‹•æ™‚é å…ˆè¼‰å…¥èªéŸ³åˆ—è¡¨
        loadChineseVoice();
    }

    window.onload = function() {
        resetGame();
        // å†æ¬¡å˜—è©¦è¼‰å…¥ï¼Œç¢ºä¿éåŒæ­¥çš„èªéŸ³åˆ—è¡¨è¢«æŠ“åˆ°
        setTimeout(loadChineseVoice, 500);
    };
</script>
</body>
</html>