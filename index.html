<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨éŸ³ç¬¦è™Ÿéš¨æ©Ÿè½è®€ç·´ç¿’ - æœ€çµ‚ä¿®æ­£ç‰ˆ (ç™¼éŸ³å¼·åˆ¶å°æ‡‰)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            margin: 0;
            color: #333;
        }

        #game-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        #stats-container {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        #bopomofo-display {
            font-weight: bold;
            margin: 40px 0;
            color: #e74c3c;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffebee;
            border-radius: 10px;
            line-height: 1; 
            transition: font-size 0.3s, color 0.3s; 
        }

        #button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        #test-button {
            background-color: #9b59b6;
        }
        #test-button:hover {
            background-color: #8e44ad;
        }

        .action-button {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }

        #next-button {
            background-color: #3498db;
        }

        #next-button:hover {
            background-color: #2980b9;
        }
        
        #listen-button {
            background-color: #2ecc71;
        }

        #listen-button:hover {
            background-color: #27ae60;
        }
        
        #reset-button {
            background-color: #f39c12; 
        }
        
        #reset-button:hover {
            background-color: #e67e22;
        }


        .action-button:active {
            transform: scale(0.98);
        }

        #message {
            margin-top: 20px;
            font-size: 1.2em;
            color: #7f8c8d;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <h1>æ³¨éŸ³ç¬¦è™Ÿéš¨æ©Ÿè½è®€ç·´ç¿’ ğŸ’¡</h1>
        
        <div id="stats-container">
            <button id="reset-button" class="action-button" onclick="resetGame()">é‡æ–°é–‹å§‹ ğŸ”„</button>
            <div id="counter-display">å·²ç·´ç¿’é¡Œæ•¸: 0</div>
        </div>

        <div id="bopomofo-display">é»æ“Šä¸‹ä¸€é¡Œé–‹å§‹</div>

        <div id="button-group">
            <button id="next-button" class="action-button" onclick="startNewRound()">ä¸‹ä¸€é¡Œ</button>
            <button id="listen-button" class="action-button" onclick="playCurrentSound()" disabled>ğŸ‘‚ è½è½çœ‹</button>
        </div>
        
        <button id="test-button" class="action-button" onclick="testSpeech()">ğŸ”Š èªéŸ³æ¸¬è©¦</button>
        
        <div id="message">è«‹é»æ“Šã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ç·´ç¿’</div>

    </div>

    <script>
        const bopomofo = [
            "ã„…", "ã„†", "ã„‡", "ã„ˆ", "ã„‰", "ã„Š", "ã„‹", "ã„Œ", "ã„", "ã„", "ã„",
            "ã„", "ã„‘", "ã„’", "ã„“", "ã„”", "ã„•", "ã„–", "ã„—", "ã„˜", "ã„™",
            "ã„§", "ã„¨", "ã„©", "ã„š", "ã„›", "ã„œ", "ã„", "ã„", "ã„Ÿ", "ã„ ", "ã„¡",
            "ã„¢", "ã„£", "ã„¤", "ã„¥", "ã„¦"
        ];

        let currentSymbol = '';
        let roundCounter = 0; 

        const displayEl = document.getElementById('bopomofo-display');
        const messageEl = document.getElementById('message');
        const listenButton = document.getElementById('listen-button');
        const counterDisplay = document.getElementById('counter-display');
        const testButton = document.getElementById('test-button');
        
        const synth = window.speechSynthesis;
        let chineseVoice = null; 
        let voicesLoaded = false;
        
        // ã€é—œéµã€‘æ³¨éŸ³ç¬¦è™Ÿåˆ°æ¼¢èªæ‹¼éŸ³ï¼ˆæˆ–èƒ½ç™¼éŸ³çš„æ›¿ä»£æ¼¢å­—ï¼‰çš„æ˜ å°„è¡¨
        // æˆ‘å€‘ç›¡é‡ä½¿ç”¨æ‹¼éŸ³æˆ–èƒ½è¢«æ‰€æœ‰ä¸­æ–‡èªéŸ³åŒ…æ­£ç¢ºç™¼éŸ³çš„å–®å­—
        const bopomofoMap = {
            "ã„…": "bo", "ã„†": "po", "ã„‡": "mo", "ã„ˆ": "fo", 
            "ã„‰": "de", "ã„Š": "te", "ã„‹": "ne", "ã„Œ": "le", 
            "ã„": "ge", "ã„": "ke", "ã„": "he",
            "ã„": "ji", "ã„‘": "qi", "ã„’": "xi", 
            "ã„“": "zhi", "ã„”": "chi", "ã„•": "shi", "ã„–": "ri", 
            "ã„—": "zi", "ã„˜": "ci", "ã„™": "si",
            "ã„§": "yi", "ã„¨": "wu", "ã„©": "yu", 
            "ã„š": "a", "ã„›": "o", "ã„œ": "e", "ã„": "Ãª", // Ãª æ‹¼éŸ³ç”¨æ–¼æº–ç¢ºç™¼éŸ³
            "ã„": "ai", "ã„Ÿ": "ei", "ã„ ": "ao", "ã„¡": "ou",
            "ã„¢": "an", "ã„£": "en", "ã„¤": "ang", "ã„¥": "eng", "ã„¦": "er"
        };


        // ----------------------------------------------------
        // I. èªéŸ³åˆæˆæ ¸å¿ƒå‡½æ•¸ (é‡å° iOS ä¿®æ­£)
        // ----------------------------------------------------

        function loadChineseVoice() {
            if (voicesLoaded) return;
            const voices = synth.getVoices();
            // å„ªå…ˆå°‹æ‰¾ zh-TWï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±ç”¨å…¶ä»–ä¸­æ–‡èªéŸ³
            chineseVoice = voices.find(voice => voice.lang === 'zh-TW' || voice.name.includes('Taiwan') || voice.lang.startsWith('zh'));
            voicesLoaded = true;
            
            if (!chineseVoice) {
                console.warn("æœªæ‰¾åˆ°ä¸­æ–‡èªéŸ³ï¼Œå°‡ä½¿ç”¨ç€è¦½å™¨é è¨­èªéŸ³ã€‚");
            }
        }
        
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadChineseVoice;
        }
        
        function ensureVoicesLoaded() {
            if (!voicesLoaded) {
                loadChineseVoice();
            }
        }

        /**
         * é€šç”¨æ’­æ”¾å‡½æ•¸ã€‚
         * @param {string} text è¦å”¸å‡ºçš„æ–‡å­—ã€‚
         * @param {HTMLElement} btn è§¸ç™¼çš„æŒ‰éˆ•å…ƒç´ ã€‚
         * @param {string} originalText æŒ‰éˆ•çš„åŸå§‹æ–‡å­—ã€‚
         */
        function speakText(text, btn, originalText) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            // ã€ä¿®æ­£ã€‘åœ¨æ’­æ”¾æ³¨éŸ³ç¬¦è™Ÿæ™‚ï¼Œå°‡å…¶æ›¿æ›ç‚ºæ‹¼éŸ³æˆ–æ›¿ä»£å­—
            let textToSpeak = text;
            if (text.length === 1 && bopomofoMap[text]) {
                textToSpeak = bopomofoMap[text];
            }
            
            ensureVoicesLoaded(); 
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            if (chineseVoice) {
                utterance.voice = chineseVoice;
                utterance.lang = chineseVoice.lang;
            } else {
                // å³ä½¿æ˜¯ zh-CN èªéŸ³åŒ…ï¼Œæˆ‘å€‘ä¹Ÿå¼·åˆ¶è¨­å®š lang ç‚º zh-TWï¼Œ
                // è®“ç³»çµ±å˜—è©¦ç”¨æœ€é©åˆçš„ä¸­æ–‡ç™¼éŸ³ä¾†è®€å‡ºæ‹¼éŸ³ã€‚
                utterance.lang = 'zh-TW'; 
            }

            // å°æ–¼å–®å€‹æ³¨éŸ³ç¬¦è™Ÿï¼Œèªé€Ÿå¯ä»¥ç¨æ…¢ä¸€äº›
            utterance.rate = 0.8; 
            utterance.pitch = 1.0; 

            btn.textContent = 'ğŸ”Š æ­£åœ¨ç™¼éŸ³...';
            btn.disabled = true;

            utterance.onend = function() {
                btn.textContent = originalText;
                btn.disabled = false;
            };
            utterance.onerror = function(e) {
                console.error("Speech Synthesis Error:", e);
                messageEl.textContent = 'èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç³»çµ±è¨­å®šã€‚';
                btn.textContent = originalText;
                btn.disabled = false;
            };

            try {
                 synth.speak(utterance);
            } catch (e) {
                utterance.onerror(e);
            }
        }

        /**
         * æ’­æ”¾ç•¶å‰æ³¨éŸ³ç¬¦è™Ÿçš„è²éŸ³ã€‚
         */
        function playCurrentSound() {
            if (!currentSymbol || listenButton.disabled) {
                return;
            }
            // é€™è£¡å‚³å…¥çš„æ˜¯æ³¨éŸ³ç¬¦è™Ÿï¼Œä½† speakText æœƒè‡ªå‹•æ›¿æ›ç‚ºæ‹¼éŸ³
            speakText(currentSymbol, listenButton, 'ğŸ‘‚ è½è½çœ‹');
        }
        
        /**
         * èªéŸ³åŠŸèƒ½æ¸¬è©¦æŒ‰éˆ•çš„å‡½æ•¸ã€‚
         */
        function testSpeech() {
            if (testButton.disabled) {
                return;
            }
            // å”¸å‡ºå®Œæ•´çš„å¥å­ï¼Œæ¸¬è©¦ç³»çµ±èªéŸ³æ˜¯å¦å¯ç”¨
            speakText('ä½ å¥½ï¼Œé€™æ˜¯èªéŸ³åŠŸèƒ½æ¸¬è©¦ï¼Œå¦‚æœè½å¾—åˆ°è²éŸ³ï¼Œè¡¨ç¤ºç¨‹å¼ç¢¼æ­£å¸¸ã€‚', testButton, 'ğŸ”Š èªéŸ³æ¸¬è©¦');
        }

        // ----------------------------------------------------
        // II. éŠæˆ²æµç¨‹æ§åˆ¶
        // ----------------------------------------------------

        function startNewRound() {
            roundCounter++; 
            counterDisplay.textContent = `å·²ç·´ç¿’é¡Œæ•¸: ${roundCounter}`;

            currentSymbol = bopomofo[Math.floor(Math.random() * bopomofo.length)];
            displayEl.textContent = currentSymbol;
            
            displayEl.style.fontSize = '15em'; 
            displayEl.style.color = '#e74c3c'; 

            listenButton.disabled = false;
            listenButton.textContent = 'ğŸ‘‚ è½è½çœ‹';
            messageEl.textContent = `æ–°çš„æ³¨éŸ³ç¬¦è™Ÿï¼š${currentSymbol}ã€‚è«‹é»æ“Šã€Œè½è½çœ‹ã€ç™¼éŸ³ã€‚`;
            
            synth.cancel(); 
        }
        
        function resetGame() {
            roundCounter = 0;
            counterDisplay.textContent = `å·²ç·´ç¿’é¡Œæ•¸: 0`;
            currentSymbol = '';
            
            displayEl.textContent = 'æº–å‚™å¥½äº†å—ï¼Ÿ';
            displayEl.style.fontSize = '3em'; 
            displayEl.style.color = '#7f8c8d'; 
            
            listenButton.disabled = true;
            listenButton.textContent = 'ğŸ‘‚ è½è½çœ‹';
            messageEl.textContent = 'è¨ˆæ•¸å·²æ­¸é›¶ã€‚è«‹é»æ“Šã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ç·´ç¿’ã€‚';

            synth.cancel(); 
        }

        // é¦–æ¬¡è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.onload = function() {
            resetGame(); 
            loadChineseVoice();
        }
    </script>
</body>
</html>